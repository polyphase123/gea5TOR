<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEA-5 Bid Evaluation Simulator (Advanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- LeafletJS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .label {
            display: inline-flex; /* Changed from block */
            align-items: center; /* Added */
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .input, .select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        .details-section {
            display: none;
            background-color: #f8f9fa;
            border-top: 1px solid #e5e7eb;
            padding: 1rem;
            margin-top: 1rem;
        }
        .legend-table th, .legend-table td { padding: 0.5rem 1rem; text-align: center; border: 1px solid #e5e7eb; }
        .legend-table th { background-color: #f3f4f6; font-weight: 600; }

        #map {
            height: 400px;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
        }

        .tooltip-icon {
            display: inline-block;
            cursor: help;
            font-weight: 500;
            color: #9ca3af; /* gray-400 */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 9999px;
            width: 1.125rem; /* 18px */
            height: 1.125rem; /* 18px */
            font-size: 0.75rem; /* 12px */
            line-height: 1rem; /* Adjust for vertical centering */
            text-align: center;
            margin-left: 0.375rem;
            vertical-align: middle;
            user-select: none; /* Prevent text selection */
        }

        .tooltip-text {
            visibility: hidden;
            width: 240px;
            background-color: #262626;
            color: #fff;
            text-align: left;
            border-radius: 0.375rem;
            padding: 0.75rem;
            position: absolute;
            z-index: 10;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            font-size: 0.875rem;
            font-weight: 400;
            line-height: 1.5;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #262626 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .my-leaflet-tooltip {
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid #9ca3af;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            white-space: nowrap;
            box-shadow: none;
            font-weight: 500;
        }
        /* Wind Turbine Styles */
        .turbine-container {
            position: fixed;
            top: 1.5rem;
            width: 80px; /* Smaller */
            height: 120px; /* Smaller */
            cursor: pointer;
            z-index: 50;
        }
        .turbine-container.left {
            left: 1.5rem;
        }
        .turbine-container.right {
            right: 1.5rem;
        }
        .tower {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 6px; /* Smaller */
            height: 80px; /* Smaller */
            background-color: #d1d5db;
            border-radius: 2px 2px 0 0;
        }
        .blades {
            position: absolute;
            top: 12px; /* Adjusted */
            left: 50%;
            width: 10px;
            height: 10px;
            transform-origin: 5px 5px;
            animation: spin 6s linear infinite;
        }
        .blades.fast-spin {
            animation: spin 1s linear infinite;
        }
        .blade {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 3px; /* Smaller */
            height: 36px; /* Smaller */
            background-color: #e5e7eb;
            border-radius: 2px;
            transform-origin: 1.5px 0; /* Adjusted */
        }
        .blade1 { transform: translate(-50%, 0) rotate(0deg); }
        .blade2 { transform: translate(-50%, 0) rotate(120deg); }
        .blade3 { transform: translate(-50%, 0) rotate(240deg); }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Toggle Switch styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #2563eb; /* blue-600 */
            transform: translateX(100%);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #2563eb; /* blue-600 */
        }
        .toggle-checkbox {
            transition: transform 0.2s ease-in-out;
        }

    </style>
</head>
<body class="text-gray-800">
    <!-- Animated Wind Turbines -->
    <div id="wind-turbine-left" class="turbine-container left">
        <div class="tower"></div>
        <div class="blades">
            <div class="blade blade1"></div>
            <div class="blade blade2"></div>
            <div class="blade blade3"></div>
        </div>
    </div>
    <div id="wind-turbine-right" class="turbine-container right">
        <div class="tower"></div>
        <div class="blades">
            <div class="blade blade1"></div>
            <div class="blade blade2"></div>
            <div class="blade blade3"></div>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Interactive GEA-5 Bid Evaluation Simulator</h1>
            <p class="text-lg text-gray-600 mt-2">For Offshore Wind (OSW) Technology</p>
            <p class="text-sm font-bold text-red-600 mt-2">Programmed by Engr. Franz Xyrlo I. Tobias, PEE</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Section -->
            <div class="lg:col-span-2">
                 <!-- Auction Bidders -->
                <div class="card">
                    <h3 class="text-xl font-semibold mb-2 text-blue-600">Auction Bidders</h3>
                     <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center">
                        <p class="text-sm text-gray-700">
                            <span class="font-semibold">Target Period:</span> 2028-2030 | 
                            <span class="font-semibold">Total Installation Target:</span> 3,300 MW
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div class="md:col-span-2">
                             <label for="bidderNameSelect" class="label text-sm">Bidder Name</label>
                             <select id="bidderNameSelect" class="input"></select>
                             <input type="text" id="otherBidderName" class="input mt-2" placeholder="Enter custom name" style="display: none;">
                        </div>
                        <div class="tooltip-container">
                            <label for="competitorPriceMin" class="label text-sm">Min Price<span class="tooltip-icon">?</span></label>
                            <input type="number" id="competitorPriceMin" class="input" value="11.50" step="0.01">
                            <span class="tooltip-text">The lowest or most likely price this bidder is expected to offer. Used for ranking and as the minimum for simulations.</span>
                        </div>
                         <div class="tooltip-container">
                            <label for="competitorPriceMax" class="label text-sm">Max Price<span class="tooltip-icon">?</span></label>
                            <input type="number" id="competitorPriceMax" class="input" placeholder="Optional" step="0.01">
                            <span class="tooltip-text">Optional. The highest price a bidder might offer. Used for simulations.</span>
                        </div>
                         <div class="tooltip-container">
                            <label for="competitorCapacity" class="label text-sm">Capacity (MW)<span class="tooltip-icon">?</span></label>
                            <input type="number" id="competitorCapacity" class="input" value="850">
                            <span class="tooltip-text">The total generation capacity this bidder is offering in Megawatts. This contributes to the Capacity Score.</span>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button id="addBidderBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Add Bidder</button>
                        <button id="simulateBidsBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Load Simulated Bids</button>
                        <button id="clearBidsBtn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Clear Bidders</button>
                    </div>
                    <div id="addBidderError" class="text-red-600 text-sm mt-2"></div>
                    <div id="simulationExplainer" class="mt-4 text-sm text-gray-600 p-3 bg-gray-50 rounded-lg" style="display: none;"></div>
                    <div id="biddersListContainer" class="mt-4 space-y-3"></div>
                </div>

                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Shared Bid Details</h2>
                
                <div class="card space-y-6">
                    <div>
                         <h3 class="text-lg font-semibold mb-2 text-gray-700">Benchmark Pricing & Foundation</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="tooltip-container">
                                <label for="monopileGearPrice" class="label">Monopile GEAR Price<span class="tooltip-icon">?</span></label>
                                <input type="number" id="monopileGearPrice" class="input" value="12.00" step="0.01">
                                <span class="tooltip-text">Green Energy Auction Reserve (GEAR) price for projects using Monopile foundations. Bids above this are disqualified if Monopile is selected.</span>
                            </div>
                            <div class="tooltip-container">
                                <label for="jacketGearPrice" class="label">Jacket GEAR Price<span class="tooltip-icon">?</span></label>
                                <input type="number" id="jacketGearPrice" class="input" value="12.10" step="0.01">
                                <span class="tooltip-text">GEAR price for projects using Jacket foundations. Bids above this are disqualified if Jacket is selected.</span>
                            </div>
                            <div class="tooltip-container">
                                <label for="foundationType" class="label">Auction Foundation<span class="tooltip-icon">?</span></label>
                                <select id="foundationType" class="select">
                                    <option value="Monopile" selected>Monopile</option>
                                    <option value="Jacket">Jacket</option>
                                </select>
                                <span class="tooltip-text">The primary foundation type for the auction. This determines which GEAR price is used as the benchmark for disqualification.</span>
                            </div>
                        </div>
                        <div class="mt-6 tooltip-container flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Enable Chinese Turbines<span class="tooltip-icon">?</span></span>
                             <div class="relative inline-block w-12 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="chineseTurbineToggle" id="chineseTurbineToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-2 appearance-none cursor-pointer"/>
                                <label for="chineseTurbineToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                             <span class="tooltip-text">Enabling this simulates a 32.5% cost reduction in GEAR prices and competitor bids, reflecting the use of cheaper turbines.</span>
                        </div>
                        <div id="gearPriceError" class="text-red-600 text-xs mt-2"></div>
                    </div>
                    <hr>
                    <div class="tooltip-container">
                        <label for="dcd" class="label text-lg font-semibold text-gray-700">Default Delivery Commencement Date (DCD)<span class="tooltip-icon">?</span></label>
                        <input type="date" id="dcd" class="input" value="2028-05-15">
                        <span class="tooltip-text">Used for manually added bidders. Simulated bidders have their own randomized DCDs.</span>
                    </div>
                    <hr>
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-gray-700">Grid Readiness</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="tooltip-container">
                                <label for="gridReadinessLevel" class="label">Grid Readiness Level<span class="tooltip-icon">?</span></label>
                                <select id="gridReadinessLevel" class="select">
                                    <option value="3">Level 3: With SIS + FS + Connection Agreement</option>
                                    <option value="2" selected>Level 2: With SIS + FS</option>
                                    <option value="1">Level 1: With SIS only</option>
                                    <option value="0">Level 0: No SIS or grid available post-2030</option>
                                </select>
                                <span class="tooltip-text">The bidder's documented progress in securing grid connection. Higher levels score better (Level 3 is highest). Level 0 is disqualified.</span>
                            </div>
                            <div class="tooltip-container">
                                <label for="gridFacilityReadinessDate" class="label">Grid Facility Readiness Date<span class="tooltip-icon">?</span></label>
                                <input type="date" id="gridFacilityReadinessDate" class="input" value="2028-08-01">
                                <span class="tooltip-text">The date the grid infrastructure is expected to be ready. A penalty is applied if the DCD is significantly earlier than this date.</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Advanced Strategic Analysis</h2>
                
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-blue-600">Markov Chain Bidding Simulation</h3>
                    <p class="text-sm text-gray-600 mb-4">This simulates how bidding strategies might evolve. Each step represents a new auction round where bidders change their strategy (aggressive, moderate, conservative) based on their previous state, creating a more realistic, evolving competitive landscape.</p>
                    <button id="runMarkovBtn" class="mt-4 w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">Simulate Next Bidding Round</button>
                </div>
                
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-blue-600">Probabilistic Analysis (Monte Carlo)</h3>
                    <p class="text-sm text-gray-600 mb-4">Simulates the auction thousands of times with random competitor prices (within their specified ranges) to calculate your probability of winning.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="monteCarloBidderSelect" class="label text-sm">Your Bid to Analyze</label>
                            <select id="monteCarloBidderSelect" class="input"></select>
                        </div>
                        <div class="tooltip-container">
                            <label for="monteCarloIterations" class="label text-sm">Simulations<span class="tooltip-icon">?</span></label>
                            <input type="number" id="monteCarloIterations" class="input" value="500">
                            <span class="tooltip-text">The number of times to run the auction simulation. Higher numbers provide more accurate probabilities but may take slightly longer to compute.</span>
                        </div>
                    </div>
                    <button id="runMonteCarloBtn" class="mt-4 w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700">Calculate Win Probability</button>
                    <div id="monteCarloResult" class="mt-4 text-center h-10 flex items-center justify-center font-semibold"></div>
                    <div id="monteCarloDiscussion" class="mt-4 text-sm text-gray-600 p-3 bg-gray-50 rounded-lg" style="display: none;"></div>
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-blue-600">Score Contribution Analysis</h3>
                    <p class="text-sm text-gray-600 mb-4">Visually compare the strengths and weaknesses of each bidder by seeing how their final score is composed across the four main criteria.</p>
                    <div>
                        <canvas id="scoreContributionChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-blue-600">Sensitivity Analysis</h3>
                    <p class="text-sm text-gray-600 mb-4">Analyze how a bidder's final rank changes as key variables are adjusted. This helps identify critical thresholds and strategic opportunities.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="sensitivityBidderSelect" class="label text-sm">Bidder to Analyze</label>
                            <select id="sensitivityBidderSelect" class="input"></select>
                        </div>
                        <div>
                            <label for="sensitivityVariableSelect" class="label text-sm">Variable to Test</label>
                            <select id="sensitivityVariableSelect" class="input">
                                <option value="price">Bid Price</option>
                                <option value="dcd">DCD</option>
                            </select>
                        </div>
                    </div>
                    <button id="runSensitivityBtn" class="mt-4 w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700">Run Sensitivity Analysis</button>
                    <div class="mt-4">
                        <canvas id="sensitivityChart"></canvas>
                    </div>
                </div>

            </div>

            <!-- Output Section -->
            <div class="lg:col-span-1">
                <div class="sticky top-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Auction Results</h2>
                    <div class="card">
                         <h3 class="text-xl font-semibold mb-4 text-blue-600 text-center">Auction Awarding</h3>
                         <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="tooltip-container">
                                <label for="installationTarget" class="label text-sm">Target (MW)<span class="tooltip-icon">?</span></label>
                                <input type="number" id="installationTarget" class="input" value="3300">
                                <span class="tooltip-text">The total capacity in Megawatts (MW) that the auction aims to award to winning bidders.</span>
                            </div>
                            <div class="tooltip-container">
                                <label for="marginalCap" class="label text-sm">Marginal Cap (MW)<span class="tooltip-icon">?</span></label>
                                <input type="number" id="marginalCap" class="input" value="100">
                                <span class="tooltip-text">An extra capacity buffer. The last winning bidder ('marginal' bidder) can be awarded up to their full bid if it's within the remaining target + this cap.</span>
                            </div>
                        </div>
                        <div class="mb-4 text-center p-2 bg-gray-100 rounded-md">
                            <p class="font-semibold text-sm">GEAR Ratio Benchmark: <span id="highestGearRatioValue" class="text-blue-600">0.000</span></p>
                            <p class="text-xs text-gray-500">Max(Benchmark Price / Bidder Price)</p>
                        </div>
                        <h4 class="text-lg font-semibold text-center text-gray-700 mb-2">Auction Ranking</h4>
                        <table class="w-full text-left text-sm">
                            <thead><tr class="border-b"><th class="py-2">Rank</th><th class="py-2">Bidder</th><th class="py-2 text-center">Score</th><th class="py-2 text-center">Awarded</th><th class="py-2 text-center">Status</th></tr></thead>
                            <tbody id="rankingTableBody"></tbody>
                        </table>
                        <button id="exportCsvBtn" class="mt-4 w-full bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800">Export to CSV</button>
                        <div id="job-estimation-results"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legends Section -->
        <div class="mt-12">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Scoring Legends & Project Map</h2>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                     <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-center">Potential OSW Project Locations</h3>
                         <div id="map"></div>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-center">DCD Scoring Table</h3>
                        <table class="w-full legend-table">
                            <thead>
                                <tr><th>Score</th><th>Start Date</th><th>End Date</th></tr>
                            </thead>
                            <tbody id="dcdScoringTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-center">Score Decrement of Advance DCD vs Grid Readiness</h3>
                        <div class="max-h-64 overflow-y-auto">
                            <table class="w-full legend-table">
                                <thead><tr><th>Days Ahead</th><th>Penalty</th></tr></thead>
                                <tbody id="penaltyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card" id="gridLegendCard">
                        <h3 class="text-xl font-semibold mb-4 text-center">Grid Score & Legend</h3>
                        <table class="w-full legend-table">
                            <thead><tr><th>Score</th><th>Level</th></tr></thead>
                            <tbody>
                                <tr><td>100</td><td>3</td></tr>
                                <tr><td>75</td><td>2</td></tr>
                                <tr><td>50</td><td>1</td></tr>
                                <tr><td>Disqualified</td><td>0</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA and PARAMETERS ---
        const WEIGHTS = { price: 0.70, dcd: 0.10, grid: 0.10, capacity: 0.10 };
        const DCD_SCORING_TABLE = [ { score: 100, start: '2028-01-01', end: '2028-03-31' }, { score: 95, start: '2028-04-01', end: '2028-06-30' }, { score: 91, start: '2028-07-01', end: '2028-09-30' }, { score: 86, start: '2028-10-01', end: '2028-12-31' }, { score: 82, start: '2029-01-01', end: '2029-03-31' }, { score: 77, start: '2029-04-01', end: '2029-06-30' }, { score: 73, start: '2029-07-01', end: '2029-09-30' }, { score: 68, start: '2029-10-01', end: '2029-12-31' }, { score: 64, start: '2030-01-01', end: '2030-03-31' }, { score: 59, start: '2030-04-01', end: '2030-06-30' }, { score: 55, start: '2030-07-01', end: '2030-09-30' }, { score: 50, start: '2030-10-01', end: '2030-12-31' } ];
        const GRID_SCORE_TABLE = { 3: 100, 2: 75, 1: 50, 0: 'Disqualified' };
        const PENALTY_TABLE = [ { days: 750, penalty: 0.75 }, { days: 720, penalty: 0.72 }, { days: 690, penalty: 0.69 }, { days: 660, penalty: 0.66 }, { days: 630, penalty: 0.63 }, { days: 600, penalty: 0.60 }, { days: 570, penalty: 0.57 }, { days: 540, penalty: 0.54 }, { days: 510, penalty: 0.51 }, { days: 480, penalty: 0.48 }, { days: 450, penalty: 0.45 }, { days: 420, penalty: 0.42 }, { days: 390, penalty: 0.39 }, { days: 360, penalty: 0.36 }, { days: 330, penalty: 0.33 }, { days: 300, penalty: 0.30 }, { days: 270, penalty: 0.27 }, { days: 240, penalty: 0.24 }, { days: 210, penalty: 0.21 }, { days: 180, penalty: 0.18 }, { days: 150, penalty: 0.15 }, { days: 120, penalty: 0.12 }, { days: 90, penalty: 0.09 }, { days: 60, penalty: 0.06 }, { days: 30, penalty: 0.03 }, { days: 0, penalty: 0.00 } ];
        const PRESET_BIDDERS = [ 
            { name: 'CIP & ACEN Corporation', capacity: 1000, location: [10.5, 122.7], info: "Guimaras Strait" }, 
            { name: 'Triconti Windkraft Group', capacity: 450, location: [18.4, 121.6], info: "Aparri Bay" }, 
            { name: 'CleanTech & The Blue Circle', capacity: 1200, location: [12.2, 121.4], info: "Bulalacao, Mindoro" }, 
            { name: 'Corio Generation', capacity: 3000, location: [14.4, 120.6], info: "Offshore Cavite" }, 
            { name: 'BlueFloat Energy', capacity: 7000, location: [14.8, 120.1], info: "Offshore Bataan" }, 
            { name: 'BuhaWind Consortium', capacity: 4000, location: [18.5, 120.5], info: "Offshore Ilocos Norte" }, 
            { name: 'San Miguel Corporation', capacity: '', location: [13.8, 120.8], info: "Offshore Batangas" }, 
            { name: 'Aboitiz Power Corp.', capacity: '', location: [15.4, 119.8], info: "Offshore Zambales" }, 
            { name: 'The Lopez Group (First Gen)', capacity: '', location: [11.2, 122.5], info: "Offshore Panay" }, 
        ];
        const BASE_GEAR_PRICES = { Monopile: 12.00, Jacket: 12.10 };
        const CHINESE_TURBINE_DISCOUNT = 0.325; // 32.5%
        const MARKOV_TRANSITIONS = {
            Aggressive: { Aggressive: 0.7, Moderate: 0.2, Conservative: 0.1 },
            Moderate: { Aggressive: 0.2, Moderate: 0.6, Conservative: 0.2 },
            Conservative: { Aggressive: 0.1, Moderate: 0.3, Conservative: 0.6 },
        };

        // --- GLOBAL STATE ---
        let bidders = [];
        let rankedBiddersCache = [];
        let scoreChart = null;
        let sensitivityChart = null;
        
        // --- DOM ELEMENTS ---
        const dom = {
            bidderNameSelect: document.getElementById('bidderNameSelect'), otherBidderName: document.getElementById('otherBidderName'),
            competitorPriceMin: document.getElementById('competitorPriceMin'), competitorPriceMax: document.getElementById('competitorPriceMax'),
            competitorCapacity: document.getElementById('competitorCapacity'), addBidderBtn: document.getElementById('addBidderBtn'),
            simulateBidsBtn: document.getElementById('simulateBidsBtn'),
            clearBidsBtn: document.getElementById('clearBidsBtn'),
            addBidderError: document.getElementById('addBidderError'), biddersListContainer: document.getElementById('biddersListContainer'),
            simulationExplainer: document.getElementById('simulationExplainer'),
            foundationType: document.getElementById('foundationType'), 
            monopileGearPrice: document.getElementById('monopileGearPrice'), jacketGearPrice: document.getElementById('jacketGearPrice'),
            gearPriceError: document.getElementById('gearPriceError'),
            dcd: document.getElementById('dcd'), gridReadinessLevel: document.getElementById('gridReadinessLevel'),
            gridFacilityReadinessDate: document.getElementById('gridFacilityReadinessDate'),
            installationTarget: document.getElementById('installationTarget'), marginalCap: document.getElementById('marginalCap'),
            highestGearRatioValue: document.getElementById('highestGearRatioValue'), rankingTableBody: document.getElementById('rankingTableBody'),
            exportCsvBtn: document.getElementById('exportCsvBtn'),
            monteCarloBidderSelect: document.getElementById('monteCarloBidderSelect'), monteCarloIterations: document.getElementById('monteCarloIterations'),
            runMonteCarloBtn: document.getElementById('runMonteCarloBtn'), monteCarloResult: document.getElementById('monteCarloResult'),
            monteCarloDiscussion: document.getElementById('monteCarloDiscussion'),
            penaltyTableBody: document.getElementById('penaltyTableBody'), dcdScoringTableBody: document.getElementById('dcdScoringTableBody'),
            gridLegendCard: document.getElementById('gridLegendCard'),
            chineseTurbineToggle: document.getElementById('chineseTurbineToggle'),
            jobEstimationResults: document.getElementById('job-estimation-results'),
            sensitivityBidderSelect: document.getElementById('sensitivityBidderSelect'),
            sensitivityVariableSelect: document.getElementById('sensitivityVariableSelect'),
            runSensitivityBtn: document.getElementById('runSensitivityBtn'),
            runMarkovBtn: document.getElementById('runMarkovBtn'),
        };
        
        // --- CORE LOGIC ---
        const getGearPrices = () => ({
            Monopile: parseFloat(dom.monopileGearPrice.value) || 12.00,
            Jacket: parseFloat(dom.jacketGearPrice.value) || 12.10,
        });

        const calculateScoresForBidder = (bidder, sharedDetails, maxValues) => {
             const scores = {}; let isDisqualified = false;
             const gearPrice = getGearPrices()[sharedDetails.foundationType];
             const priceToScore = bidder.price || bidder.priceMin;
             if (priceToScore > gearPrice) { isDisqualified = true; }
             const gearRatio = priceToScore > 0 ? gearPrice / priceToScore : 0;
             scores.gearRatio = gearRatio;
             const normalizedRatio = maxValues.highestGearRatio > 0 ? gearRatio / maxValues.highestGearRatio : 0;
             scores.priceRaw = isDisqualified ? 0 : 50 + (normalizedRatio * 50);
             scores.priceFinal = scores.priceRaw * WEIGHTS.price;
             const dcdDate = new Date(bidder.dcd || sharedDetails.dcd);
             const dcdEntry = DCD_SCORING_TABLE.find(e => dcdDate >= new Date(e.start) && dcdDate <= new Date(e.end));
             scores.dcdRaw = dcdEntry ? dcdEntry.score : 0;
             if (!dcdEntry) isDisqualified = true;
             scores.dcdFinal = scores.dcdRaw * WEIGHTS.dcd;
             const gridLevel = parseInt(sharedDetails.gridReadinessLevel);
             const gridBaseScore = GRID_SCORE_TABLE[gridLevel];
             if (gridBaseScore === 'Disqualified') isDisqualified = true;
             const gridDate = new Date(sharedDetails.gridFacilityReadinessDate);
             const advanceDays = Math.max(0, (gridDate - dcdDate) / (1000 * 60 * 60 * 24) * -1);
             const penaltyEntry = PENALTY_TABLE.find(p => advanceDays >= p.days);
             const penaltyPercent = penaltyEntry ? penaltyEntry.penalty : 0;
             scores.gridRaw = isDisqualified ? 0 : gridBaseScore * (1 - (penaltyPercent * 0.75));
             scores.gridFinal = scores.gridRaw * WEIGHTS.grid;
             scores.capacityRaw = maxValues.maxOfferedCapacity > 0 ? (bidder.capacity / maxValues.maxOfferedCapacity) * 100 : 0;
             scores.capacityFinal = scores.capacityRaw * WEIGHTS.capacity;
             scores.total = isDisqualified ? 0 : scores.priceFinal + scores.dcdFinal + scores.gridFinal + scores.capacityFinal;
             scores.isDisqualified = isDisqualified;
             return scores;
        };

        const runFullAuction = (currentBidders, sharedDetails) => {
            const activeBidders = currentBidders.filter(b => b.enabled);
            if (activeBidders.length === 0) return { rankedBidders: [], highestGearRatio: 0 };
            
            let highestGearRatio = 0; 
            let maxOfferedCapacity = 0;
            const gearPrice = getGearPrices()[sharedDetails.foundationType];

            activeBidders.forEach(bid => {
                const price = bid.price || bid.priceMin;
                if (price <= gearPrice && price > 0) { highestGearRatio = Math.max(highestGearRatio, gearPrice / price); }
                maxOfferedCapacity = Math.max(maxOfferedCapacity, bid.capacity);
            });

            const scoredBidders = activeBidders.map(bid => ({ ...bid, ...calculateScoresForBidder(bid, sharedDetails, { highestGearRatio, maxOfferedCapacity }) }));
            const rankedBidders = scoredBidders.sort((a, b) => b.total - a.total);

            let remainingTarget = parseFloat(dom.installationTarget.value) || 0;
            const marginalCap = parseFloat(dom.marginalCap.value) || 0;
            let marginalBidderFound = false;
            
            rankedBidders.forEach(bid => {
                if (bid.isDisqualified) { 
                    bid.awardStatus = 'Disqualified'; 
                    bid.awardedMW = 0; 
                    return; 
                }
                if (remainingTarget > 0 && !marginalBidderFound) {
                    if (bid.capacity <= remainingTarget) { 
                        bid.awardStatus = 'Winner'; 
                        bid.awardedMW = bid.capacity; 
                        remainingTarget -= bid.capacity; 
                    } else { 
                        bid.awardStatus = 'Marginal'; 
                        bid.awardedMW = Math.min(bid.capacity, remainingTarget + marginalCap); 
                        remainingTarget = 0; 
                        marginalBidderFound = true; 
                    }
                } else { 
                    bid.awardStatus = 'Loser'; 
                    bid.awardedMW = 0; 
                }
            });

            return { rankedBidders, highestGearRatio };
        };
        
        const validateInputs = () => {
            const monopilePrice = parseFloat(dom.monopileGearPrice.value);
            const jacketPrice = parseFloat(dom.jacketGearPrice.value);
            if (!isNaN(monopilePrice) && !isNaN(jacketPrice) && jacketPrice < monopilePrice) {
                dom.jacketGearPrice.classList.add('border-red-500');
                dom.gearPriceError.textContent = 'Jacket price should typically be higher than Monopile price.';
            } else {
                dom.jacketGearPrice.classList.remove('border-red-500');
                dom.gearPriceError.textContent = '';
            }
        };

        const calculateAndRender = () => {
            validateInputs();
            const sharedDetails = { 
                foundationType: dom.foundationType.value, 
                dcd: dom.dcd.value,
                gridReadinessLevel: dom.gridReadinessLevel.value, 
                gridFacilityReadinessDate: dom.gridFacilityReadinessDate.value 
            };
            const { rankedBidders, highestGearRatio } = runFullAuction(bidders, sharedDetails);
            rankedBiddersCache = rankedBidders;
            updateUI(rankedBidders, highestGearRatio);
            updateJobEstimation(rankedBidders);
            updateScoreContributionChart(rankedBidders);
        };
        
        // --- UI UPDATE ---
        const updateUI = (rankedBidders, highestGearRatio) => {
            dom.highestGearRatioValue.textContent = highestGearRatio.toFixed(3);
            dom.biddersListContainer.innerHTML = bidders.map(bid => {
                const rankedBid = rankedBidders.find(rb => rb.id === bid.id) || bid;
                return generateBidderHTML(rankedBid, rankedBidders.indexOf(rankedBid));
            }).join('');
            
            let rankingHTML = rankedBidders.map((bid, index) => generateRankingRowHTML(bid, index)).join('');
            const blankRowCount = Math.max(0, 5 - rankedBidders.length);
            for (let i = 0; i < blankRowCount; i++) {
                rankingHTML += `<tr class="border-b h-10"><td class="py-2 text-gray-400">${rankedBidders.length + i + 1}</td><td class="text-gray-400">-</td><td class="text-center text-gray-400">-</td><td class="text-center text-gray-400">-</td><td class="text-center text-gray-400">-</td></tr>`;
            }
            dom.rankingTableBody.innerHTML = rankingHTML;
            updateBidderSelects();
        };

        const updateJobEstimation = (rankedBidders) => {
            const totalAwardedMW = rankedBidders
                .filter(b => b.awardStatus === 'Winner' || b.awardStatus === 'Marginal')
                .reduce((total, bidder) => total + bidder.awardedMW, 0);

            const estimatedJobs = Math.round(totalAwardedMW * 3);

            if (totalAwardedMW > 0) {
                dom.jobEstimationResults.innerHTML = `
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-center text-gray-700 mb-2">Socio-Economic Impact</h4>
                        <div class="text-center p-3 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-sm text-gray-600">Total Awarded Capacity:</p>
                            <p class="text-2xl font-bold text-green-700">${totalAwardedMW.toLocaleString()} MW</p>
                            <p class="text-sm text-gray-600 mt-2">Estimated Jobs Generated:</p>
                            <p class="text-2xl font-bold text-green-700">${estimatedJobs.toLocaleString()}</p>
                            <div class="text-xs text-gray-500 mt-2 tooltip-container inline-block">
                                (Based on an estimate of ~3 jobs/MW)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text" style="width: 280px; bottom: 120%;">This is a high-level estimate combining construction, manufacturing, and long-term operations jobs over the project's lifecycle. Actual figures can vary based on local content policies and supply chain development.</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                dom.jobEstimationResults.innerHTML = '';
            }
        };

        // --- HTML GENERATORS ---
        const generateBidderHTML = (bidder, index) => {
             const isEnabled = bidder.enabled !== false;
             const bgColor = !isEnabled ? 'bg-gray-200' : (bidder.isDisqualified ? 'bg-red-50' : (index === 0 ? 'bg-blue-50' : 'bg-gray-50'));
             
             let priceText = `₱${bidder.priceMin.toFixed(2)}`;
             if (bidder.priceMax) {
                priceText = `₱${bidder.priceMin.toFixed(2)} - ₱${bidder.priceMax.toFixed(2)}`;
             }
             const dcdText = bidder.dcd ? new Date(bidder.dcd + 'T00:00:00').toLocaleDateString() : 'Default';

             return `<div class="border rounded-lg p-3 ${bgColor}">
                    <div class="grid grid-cols-8 gap-2 items-center text-sm">
                        <div class="col-span-3 font-semibold text-gray-800">
                            <input type="checkbox" onchange="toggleBidder('${bidder.id}')" ${isEnabled ? 'checked' : ''} class="mr-2 h-4 w-4 align-middle">
                            <span class="align-middle">${index >= 0 ? index + 1 + '.' : ''} ${bidder.name}</span>
                        </div>
                        <div class="text-center text-xs"><span class="block text-gray-500">Price Range</span> ${priceText}</div>
                        <div class="text-center"><span class="block text-xs text-gray-500">Capacity</span> ${bidder.capacity} MW</div>
                        <div class="text-center text-xs"><span class="block text-gray-500">DCD</span> ${dcdText}</div>
                        <div class="text-center font-bold text-blue-600"><span class="block text-xs text-gray-500 font-medium">Score</span> ${bidder.total ? bidder.total.toFixed(2) : '-'}</div>
                        <div class="text-right"><button onclick="toggleDetails('${bidder.id}')" class="text-xs bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-1 px-2 rounded">Details</button> <button onclick="removeBidder('${bidder.id}')" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">&times;</button></div>
                    </div>
                    <div id="details-${bidder.id}" class="details-section">${generateScoreBreakdownHTML(bidder)}</div>
                </div>`;
        };
        
        const generateScoreBreakdownHTML = (bidder) => {
             if (!bidder || bidder.priceFinal === undefined) return 'Run simulation to see score breakdown.';
             return `<table class="w-full text-left text-xs">
                    <thead><tr class="border-b"><th class="py-1">Criterion</th><th class="text-center">Raw</th><th class="text-center">Final</th></tr></thead>
                    <tbody>
                        <tr><td>Price</td><td class="text-center">${bidder.priceRaw.toFixed(2)}</td><td class="text-center">${bidder.priceFinal.toFixed(2)}</td></tr>
                        <tr class="bg-white"><td>DCD</td><td class="text-center">${bidder.dcdRaw.toFixed(2)}</td><td class="text-center">${bidder.dcdFinal.toFixed(2)}</td></tr>
                        <tr><td>Grid</td><td class="text-center">${bidder.gridRaw.toFixed(2)}</td><td class="text-center">${bidder.gridFinal.toFixed(2)}</td></tr>
                        <tr class="bg-white"><td>Capacity</td><td class="text-center">${bidder.capacityRaw.toFixed(2)}</td><td class="text-center">${bidder.capacityFinal.toFixed(2)}</td></tr>
                    </tbody>
                </table>`;
        };

        const generateRankingRowHTML = (bid, index) => {
             let statusClass = bid.awardStatus === 'Winner' || bid.awardStatus === 'Marginal' ? 'text-green-600' : 'text-red-600';
             return `<tr class="border-b"><td class="py-2">${index + 1}</td><td class="py-2 font-medium">${bid.name}</td><td class="py-2 text-center">${bid.total.toFixed(2)}</td><td class="py-2 text-center">${bid.awardedMW}</td><td class="py-2 text-center font-semibold ${statusClass}">${bid.awardStatus}</td></tr>`;
        };
        
        const generateMonteCarloDiscussion = (bidderToAnalyze, probability, requiredPriceDrops, scoreGaps, sharedDetails) => {
            const bidderName = bidderToAnalyze.name;
            let baseAdvice = '';
            if (probability < 30) {
                baseAdvice = `To improve <strong>${bidderName}'s</strong> chances, significant bid improvements are needed.`;
            } else if (probability < 70) {
                baseAdvice = `<strong>${bidderName}</strong> has a moderate chance of winning. The outcome is sensitive to how aggressively competitors bid. Small improvements could increase the win probability.`;
            } else {
                baseAdvice = `<strong>${bidderName}</strong> is in a strong position. The current bid is competitive across most likely scenarios.`;
            }

            let suggestionHtml = '';
            if (probability < 99.99 && scoreGaps.length > 0) {
                const avgScoreGap = scoreGaps.reduce((a, b) => a + b, 0) / scoreGaps.length;
                const aDcd = bidderToAnalyze.dcd || sharedDetails.dcd;

                // DCD Suggestion
                const currentDcdScore = DCD_SCORING_TABLE.find(e => new Date(aDcd) >= new Date(e.start + 'T00:00:00') && new Date(aDcd) <= new Date(e.end + 'T00:00:00'))?.score || 0;
                const requiredDcdScoreImprovement = avgScoreGap / WEIGHTS.dcd;
                const targetDcdScore = currentDcdScore + requiredDcdScoreImprovement;
                const betterDcdEntry = DCD_SCORING_TABLE.find(e => e.score >= targetDcdScore);
                const dcdSuggestion = betterDcdEntry ? `Improving the DCD score to ~${Math.ceil(targetDcdScore)} (e.g., by setting a DCD around <strong>${new Date(betterDcdEntry.start+'T00:00:00').toLocaleDateString()}</strong>) could close this gap.` : 'The required DCD improvement is too large to be feasible.';

                // Grid Suggestion
                const currentGridLevel = parseInt(sharedDetails.gridReadinessLevel);
                let gridSuggestion = '';
                if (currentGridLevel < 3) {
                    const currentGridBaseScore = GRID_SCORE_TABLE[currentGridLevel] || 0;
                    const gridDate = new Date(sharedDetails.gridFacilityReadinessDate);
                    const dcdDate = new Date(aDcd);
                    const advanceDays = Math.max(0, (gridDate - dcdDate) / (1000 * 60 * 60 * 24) * -1);
                    const penaltyEntry = PENALTY_TABLE.find(p => advanceDays >= p.days);
                    const penaltyPercent = penaltyEntry ? penaltyEntry.penalty : 0;
                    const currentGridRawScore = currentGridBaseScore * (1 - (penaltyPercent * 0.75));

                    const requiredGridScoreImprovement = avgScoreGap / WEIGHTS.grid;
                    const targetGridScore = currentGridRawScore + requiredGridScoreImprovement;

                    const nextLevel = currentGridLevel + 1;
                    const nextLevelGridBaseScore = GRID_SCORE_TABLE[nextLevel] || 0;
                    const nextLevelGridRawScore = nextLevelGridBaseScore * (1 - (penaltyPercent * 0.75));
                    
                    if (targetGridScore <= nextLevelGridRawScore) {
                        gridSuggestion = `Improving Grid Readiness to <strong>Level ${nextLevel}</strong> would likely be sufficient to become a winner.`;
                    } else {
                        gridSuggestion = `Improving Grid Readiness to <strong>Level ${nextLevel}</strong> would help but may not be enough on its own.`;
                    }
                }

                // Price Suggestion (now more robust)
                let priceSuggestionText = '';
                if (requiredPriceDrops.length > 0) {
                    const avgPriceDrop = requiredPriceDrops.reduce((a, b) => a + b, 0) / requiredPriceDrops.length;
                    priceSuggestionText = `A price reduction of approximately <strong class="text-lg">₱${avgPriceDrop.toFixed(2)}</strong> was a common path to winning in the simulations. This is the most direct lever.`;
                } else {
                    priceSuggestionText = `The required price reduction appears to be significant. Closing the average score gap of <strong>${avgScoreGap.toFixed(2)} points</strong> through pricing is the most direct strategy.`;
                }
                
                suggestionHtml = `
                    <div class="mt-4 pt-3 border-t border-gray-300">
                        <h5 class="font-bold text-gray-800">Actionable Strategies to Win</h5>
                        <p class="text-xs text-gray-600 mb-2">In the simulations where this bid lost, the average score gap to the last winner was <strong>${avgScoreGap.toFixed(2)}</strong> points. Here are specific ways to close that gap:</p>
                        <div class="space-y-3 mt-3">
                            <div class="p-3 bg-white border border-gray-200 rounded-md">
                                <p class="font-semibold text-blue-700">1. Adjust Bid Price</p>
                                <p class="text-sm text-gray-700">${priceSuggestionText}</p>
                            </div>
                            <div class="p-3 bg-white border border-gray-200 rounded-md">
                                <p class="font-semibold text-blue-700">2. Improve Project Timelines</p>
                                <p class="text-sm text-gray-700">${dcdSuggestion}</p>
                                ${gridSuggestion ? `<p class="text-sm text-gray-700 mt-2">${gridSuggestion}</p>` : ''}
                            </div>
                             <div class="p-3 bg-white border border-gray-200 rounded-md">
                                <p class="font-semibold text-blue-700">3. Re-evaluate Capacity</p>
                                <p class="text-sm text-gray-700">While increasing capacity can improve your score, it is generally less impactful than price or timelines due to the normalization against the largest bidder. Significant changes are needed to see a major score impact.</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `<h4 class="font-semibold mb-2 text-gray-800">Analysis for ${bidderName}</h4>
                    <p>${baseAdvice}</p>
                    ${suggestionHtml}`;
        };


        // --- EVENT HANDLERS & FEATURES ---
        const addBidder = () => {
            dom.addBidderError.textContent = '';
            ['competitorPriceMin', 'competitorPriceMax'].forEach(id => dom[id].classList.remove('border-red-500'));
            dom.simulationExplainer.style.display = 'none';

            const selectedName = dom.bidderNameSelect.value;
            const baseName = selectedName === 'other' ? dom.otherBidderName.value.trim() : selectedName;
            const priceMin = parseFloat(dom.competitorPriceMin.value);
            const priceMax = dom.competitorPriceMax.value ? parseFloat(dom.competitorPriceMax.value) : null;
            const capacity = parseInt(dom.competitorCapacity.value);
            
            if (priceMax !== null && priceMax < priceMin) {
                dom.addBidderError.textContent = 'Max price cannot be lower than Min price.';
                dom.competitorPriceMin.classList.add('border-red-500');
                dom.competitorPriceMax.classList.add('border-red-500');
                return;
            }

            if (baseName && !isNaN(priceMin) && !isNaN(capacity)) {
                const existingCount = bidders.filter(b => b.name.startsWith(baseName)).length;
                const name = existingCount > 0 ? `${baseName} Lot ${existingCount + 1}` : baseName;
                
                const isChineseEnabled = dom.chineseTurbineToggle.checked;
                const discountFactor = isChineseEnabled ? (1 - CHINESE_TURBINE_DISCOUNT) : 1;

                bidders.push({ 
                    id: `bid_${Date.now()}`, 
                    name, 
                    basePriceMin: priceMin,
                    basePriceMax: priceMax,
                    priceMin: priceMin * discountFactor,
                    priceMax: priceMax ? priceMax * discountFactor : null,
                    capacity,
                    enabled: true,
                });
                dom.otherBidderName.value = '';
                ['competitorPriceMin', 'competitorPriceMax'].forEach(id => dom[id].value = '');
                dom.bidderNameSelect.selectedIndex = 0;
                handleBidderSelectChange();
                calculateAndRender();
            } else {
                dom.addBidderError.textContent = 'Please provide a valid name, min price, and capacity.';
            }
        };

        const handleBidderSelectChange = () => {
            const selectedValue = dom.bidderNameSelect.value;
            if (selectedValue === 'other') {
                dom.otherBidderName.style.display = 'block';
                dom.competitorCapacity.value = '';
            } else {
                dom.otherBidderName.style.display = 'none';
                const selectedBidder = PRESET_BIDDERS.find(b => b.name === selectedValue);
                if (selectedBidder) { dom.competitorCapacity.value = selectedBidder.capacity; }
            }
        };

        const simulateBids = () => {
             bidders = []; // Clear existing bidders
            const simulatedBiddersList = [
                { name: 'CIP & ACEN Corporation', capacity: 1000, priceTier: 'top' },
                { name: 'San Miguel Corporation', capacity: 800, priceTier: 'top' },
                { name: 'Corio Generation', capacity: 600, priceTier: 'mid' },
                { name: 'Triconti Windkraft Group', capacity: 450, priceTier: 'mid' },
                { name: 'Aboitiz Power Corp.', capacity: 500, priceTier: 'mid' },
                { name: 'The Lopez Group (First Gen)', capacity: 400, priceTier: 'high' },
                { name: 'CleanTech & The Blue Circle', capacity: 1200, priceTier: 'mid' },
                { name: 'BlueFloat Energy', capacity: 750, priceTier: 'high' },
                { name: 'BuhaWind Consortium', capacity: 700, priceTier: 'high' }
            ];

            const dcdQuarters = DCD_SCORING_TABLE.map(d => d.start);
            const isChineseEnabled = dom.chineseTurbineToggle.checked;
            const discountFactor = isChineseEnabled ? (1 - CHINESE_TURBINE_DISCOUNT) : 1;


            simulatedBiddersList.forEach(pBid => {
                let basePrice;
                if (pBid.priceTier === 'top') basePrice = 10.90 + Math.random() * 0.4; // 10.90 - 11.30
                else if (pBid.priceTier === 'mid') basePrice = 11.10 + Math.random() * 0.5; // 11.10 - 11.60
                else basePrice = 11.30 + Math.random() * 0.4; // 11.30 - 11.70
                
                const basePriceMin = parseFloat(basePrice.toFixed(2));
                const basePriceMax = parseFloat((basePriceMin + 0.2 + Math.random() * 0.1).toFixed(2));
                
                // Assign a random DCD, favoring earlier dates for 'top' tier
                let dcd;
                if(pBid.priceTier === 'top' && Math.random() < 0.6) { // 60% chance of being in the first half of 2028
                    dcd = dcdQuarters[Math.floor(Math.random() * 2)];
                } else {
                    dcd = dcdQuarters[Math.floor(Math.random() * dcdQuarters.length)];
                }

                bidders.push({ 
                    ...pBid, 
                    id: `bid_${Date.now()}_${Math.random()}`,
                    basePriceMin: basePriceMin,
                    basePriceMax: basePriceMax,
                    priceMin: basePriceMin * discountFactor,
                    priceMax: basePriceMax * discountFactor,
                    dcd,
                    enabled: true,
                });
            });
            
            calculateAndRender();
            updateSimulationExplainer(rankedBiddersCache);
        };
        
        const updateSimulationExplainer = (rankedBidders) => {
            if (!rankedBidders || rankedBidders.length === 0) {
                dom.simulationExplainer.style.display = 'none';
                return;
            }

            const topBidder = rankedBidders[0];
            const marginalBidder = rankedBidders.find(b => b.awardStatus === 'Marginal');
            
            let explainerHTML = `<h4 class="font-semibold text-gray-800 mb-2">Simulated Auction Analysis</h4>`;
            explainerHTML += `<p class="mb-2">This is one of many possible outcomes. Ranking is dynamic because each simulation randomizes both <strong>Price</strong> and <strong>Delivery Commencement Date (DCD)</strong> for each bidder.</p>`;

            const topBidderDCD = new Date(topBidder.dcd + 'T00:00:00').toLocaleDateString();
            explainerHTML += `<p class="mb-2">In this scenario, <strong>${topBidder.name}</strong> ranked #1. Their success is a combination of a competitive price (<strong>₱${topBidder.priceMin.toFixed(2)}</strong>) and a favorable DCD (<strong>${topBidderDCD}</strong>), resulting in a high total score.</p>`;

            if (marginalBidder) {
                explainerHTML += `<p>The crucial 'marginal' spot was won by <strong>${marginalBidder.name}</strong>. Their total score of <strong>${marginalBidder.total.toFixed(2)}</strong> was just enough to be the last bidder awarded capacity, securing the final <strong>${marginalBidder.awardedMW} MW</strong> available.</p>`;
            } else {
                 explainerHTML += `<p>In this round, the winning bids perfectly matched the auction's capacity target, so no single 'marginal' bidder was declared.</p>`;
            }

            dom.simulationExplainer.innerHTML = explainerHTML;
            dom.simulationExplainer.style.display = 'block';
        };

        const handleTurbineToggle = () => {
            const isChineseEnabled = dom.chineseTurbineToggle.checked;
            const discountFactor = isChineseEnabled ? (1 - CHINESE_TURBINE_DISCOUNT) : 1;

            // Update GEAR prices
            dom.monopileGearPrice.value = (BASE_GEAR_PRICES.Monopile * discountFactor).toFixed(2);
            dom.jacketGearPrice.value = (BASE_GEAR_PRICES.Jacket * discountFactor).toFixed(2);

            // Update existing bidder prices
            bidders.forEach(bid => {
                bid.priceMin = bid.basePriceMin * discountFactor;
                if (bid.basePriceMax) {
                    bid.priceMax = bid.basePriceMax * discountFactor;
                }
            });

            calculateAndRender();
        };

        const clearBidders = () => {
            bidders = [];
            dom.simulationExplainer.style.display = 'none';
            calculateAndRender();
        };
        
        window.toggleBidder = (id) => {
            const bidder = bidders.find(b => b.id === id);
            if (bidder) {
                bidder.enabled = !bidder.enabled;
                calculateAndRender();
            }
        };

        window.removeBidder = (id) => { 
            bidders = bidders.filter(b => b.id !== id); 
            if (bidders.length === 0) {
                dom.simulationExplainer.style.display = 'none';
            }
            calculateAndRender(); 
            if(dom.simulationExplainer.style.display === 'block'){
                updateSimulationExplainer(rankedBiddersCache);
            }
        };
        window.toggleDetails = (id) => { 
            const detailsEl = document.getElementById(`details-${id}`);
            detailsEl.style.display = detailsEl.style.display === 'block' ? 'none' : 'block'; 
        };

        // Export to CSV
        const exportToCsv = () => {
            if (rankedBiddersCache.length === 0) {
                alert("No data to export. Please add bidders and run the simulation first.");
                return;
            }

            const headers = [
                "Rank", "Bidder", "Award Status", "Awarded MW", "Total Score",
                "Price (Final)", "DCD (Final)", "Grid (Final)", "Capacity (Final)",
                "Price (Raw)", "DCD (Raw)", "Grid (Raw)", "Capacity (Raw)",
                "Bid Price (Min)", "Simulated DCD", "Bid Capacity (MW)"
            ];

            const rows = rankedBiddersCache.map((bid, index) => [
                index + 1,
                `"${bid.name}"`,
                bid.awardStatus,
                bid.awardedMW,
                bid.total.toFixed(4),
                bid.priceFinal.toFixed(4),
                bid.dcdFinal.toFixed(4),
                bid.gridFinal.toFixed(4),
                bid.capacityFinal.toFixed(4),
                bid.priceRaw.toFixed(4),
                bid.dcdRaw.toFixed(4),
                bid.gridRaw.toFixed(4),
                bid.capacityRaw.toFixed(4),
                bid.priceMin.toFixed(2),
                bid.dcd || "N/A",
                bid.capacity
            ]);

            const csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(",") + "\n" 
                + rows.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "gea5_auction_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // --- Monte Carlo Analysis ---
        const runMonteCarloAnalysis = async () => {
            const bidderId = dom.monteCarloBidderSelect.value;
            const iterations = parseInt(dom.monteCarloIterations.value);
            const bidderToAnalyze = bidders.find(b => b.id === bidderId);
            if (!bidderId || !bidderToAnalyze || isNaN(iterations) || iterations <= 0) { 
                dom.addBidderError.textContent = 'Please select a valid bidder and set simulations for Monte Carlo analysis.';
                return; 
            }

            dom.addBidderError.textContent = '';
            dom.monteCarloResult.innerHTML = `<span class="text-gray-500">Running simulations...</span>`;
            dom.monteCarloDiscussion.style.display = 'block';
            await new Promise(resolve => setTimeout(resolve, 50));

            let winCount = 0;
            const sharedDetails = { 
                foundationType: dom.foundationType.value, 
                dcd: dom.dcd.value, 
                gridReadinessLevel: dom.gridReadinessLevel.value, 
                gridFacilityReadinessDate: dom.gridFacilityReadinessDate.value 
            };
            
            let requiredPriceDrops = [];
            let scoreGaps = [];

            for (let i = 0; i < iterations; i++) {
                const simBidders = JSON.parse(JSON.stringify(bidders.filter(b => b.enabled)));
                simBidders.forEach(bid => {
                    bid.price = bid.priceMin; // Use the base price for all
                    if (bid.id !== bidderId) {
                        if (bid.priceMax && bid.priceMax > bid.priceMin) {
                           // Randomize competitor prices
                            bid.price = Math.random() * (bid.priceMax - bid.priceMin) + bid.priceMin;
                        }
                    }
                });

                const { rankedBidders } = runFullAuction(simBidders, sharedDetails);
                const targetResult = rankedBidders.find(b => b.id === bidderId);
                
                if (targetResult && (targetResult.awardStatus === 'Winner' || targetResult.awardStatus === 'Marginal')) {
                    winCount++;
                } else if (targetResult) { // Bidder lost
                    const winningBidders = rankedBidders.filter(b => b.awardStatus === 'Winner' || b.awardStatus === 'Marginal');
                    if (winningBidders.length > 0) {
                        const lastWinnerScore = winningBidders[winningBidders.length - 1].total;
                        const scoreGap = lastWinnerScore - targetResult.total;
                        if (scoreGap > 0) {
                           scoreGaps.push(scoreGap);
                           let testBidders = JSON.parse(JSON.stringify(simBidders));
                           let testBidder = testBidders.find(b => b.id === bidderId);
                           const originalPrice = testBidder.price;
                           let newPrice = originalPrice;
                           for (let p = 0; p < 300; p++) {
                               newPrice -= 0.01;
                               if (newPrice <= 0) break;
                               testBidder.price = newPrice;
                               const { rankedBidders: testRanked } = runFullAuction(testBidders, sharedDetails);
                               const testTargetResult = testRanked.find(b => b.id === bidderId);
                               if (testTargetResult && (testTargetResult.awardStatus === 'Winner' || testTargetResult.awardStatus === 'Marginal')) {
                                   requiredPriceDrops.push(originalPrice - newPrice);
                                   break;
                               }
                           }
                        }
                    }
                }
            }
            const winProbability = (winCount / iterations) * 100;
            dom.monteCarloResult.innerHTML = `Win Probability: <span class="text-teal-600">${winProbability.toFixed(2)}%</span>`;
            
            dom.monteCarloDiscussion.innerHTML = generateMonteCarloDiscussion(
                bidderToAnalyze, winProbability, requiredPriceDrops, scoreGaps, sharedDetails
            );
        };

        const updateBidderSelects = () => {
            const activeBidders = bidders.filter(b => b.enabled);
            const currentMonteCarloId = dom.monteCarloBidderSelect.value;
            const currentSensitivityId = dom.sensitivityBidderSelect.value;
            
            [dom.monteCarloBidderSelect, dom.sensitivityBidderSelect].forEach(select => {
                select.innerHTML = '';
                activeBidders.forEach(bid => {
                    const option = document.createElement('option');
                    option.value = bid.id;
                    option.textContent = bid.name;
                    select.appendChild(option);
                });
            });

             dom.monteCarloBidderSelect.value = currentMonteCarloId || (activeBidders[0] ? activeBidders[0].id : '');
             dom.sensitivityBidderSelect.value = currentSensitivityId || (activeBidders[0] ? activeBidders[0].id : '');
        };
        
        // --- MAP INITIALIZATION ---
        const initMap = () => {
            const map = L.map('map').setView([12.8797, 121.7740], 6); // Centered on the Philippines
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            PRESET_BIDDERS.forEach(bidder => {
                if(bidder.location) {
                    let tooltipContent = `<b>${bidder.name}</b><br>${bidder.info}`;
                    if (bidder.capacity) {
                        tooltipContent += `<br><em>${bidder.capacity} MW</em>`;
                    }

                    L.marker(bidder.location).addTo(map)
                        .bindTooltip(tooltipContent, {
                            permanent: true, 
                            direction: 'top',
                            offset: [0, -10],
                            className: 'my-leaflet-tooltip'
                        });
                }
            });
        };

        let speedUpTimeout;
        const triggerSpeedUp = () => {
            const allBlades = document.querySelectorAll('.blades');
            allBlades.forEach(blades => blades.classList.add('fast-spin'));
            
            clearTimeout(speedUpTimeout);
            speedUpTimeout = setTimeout(() => {
                allBlades.forEach(blades => blades.classList.remove('fast-spin'));
            }, 3000);
        };
        
        const updateScoreContributionChart = (rankedBidders) => {
            const ctx = document.getElementById('scoreContributionChart').getContext('2d');
            if (scoreChart) {
                scoreChart.destroy();
            }
            scoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rankedBidders.map(b => b.name),
                    datasets: [
                        { label: 'Price Score', data: rankedBidders.map(b => b.priceFinal), backgroundColor: 'rgba(59, 130, 246, 0.7)' },
                        { label: 'DCD Score', data: rankedBidders.map(b => b.dcdFinal), backgroundColor: 'rgba(16, 185, 129, 0.7)' },
                        { label: 'Grid Score', data: rankedBidders.map(b => b.gridFinal), backgroundColor: 'rgba(239, 68, 68, 0.7)' },
                        { label: 'Capacity Score', data: rankedBidders.map(b => b.capacityFinal), backgroundColor: 'rgba(245, 158, 11, 0.7)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Total Score' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        };
        
        const runSensitivityAnalysis = () => {
             const bidderId = dom.sensitivityBidderSelect.value;
             const variable = dom.sensitivityVariableSelect.value;
             const targetBidder = bidders.find(b => b.id === bidderId);
             
             if (!targetBidder) {
                 alert("Please select a valid bidder to analyze.");
                 return;
             }
             
             const sharedDetails = {
                foundationType: dom.foundationType.value,
                dcd: dom.dcd.value,
                gridReadinessLevel: dom.gridReadinessLevel.value,
                gridFacilityReadinessDate: dom.gridFacilityReadinessDate.value
             };
             
             let analysisData = { labels: [], ranks: [] };
             
             if (variable === 'price') {
                 for (let i = -10; i <= 10; i++) {
                     const price = targetBidder.priceMin + (i * 0.05);
                     if (price <= 0) continue;
                     
                     let tempBidders = JSON.parse(JSON.stringify(bidders));
                     let tempTarget = tempBidders.find(b => b.id === bidderId);
                     tempTarget.priceMin = price;
                     
                     const { rankedBidders } = runFullAuction(tempBidders, sharedDetails);
                     const rank = rankedBidders.findIndex(b => b.id === bidderId) + 1;
                     
                     analysisData.labels.push(price.toFixed(2));
                     analysisData.ranks.push(rank > 0 ? rank : rankedBidders.length + 1);
                 }
             } else if (variable === 'dcd') {
                DCD_SCORING_TABLE.forEach(dcdEntry => {
                    let tempBidders = JSON.parse(JSON.stringify(bidders));
                    let tempTarget = tempBidders.find(b => b.id === bidderId);
                    tempTarget.dcd = dcdEntry.start; // Use the start of the quarter for analysis

                    const { rankedBidders } = runFullAuction(tempBidders, sharedDetails);
                    const rank = rankedBidders.findIndex(b => b.id === bidderId) + 1;

                    analysisData.labels.push(new Date(dcdEntry.start + 'T00:00:00').toLocaleDateString());
                    analysisData.ranks.push(rank > 0 ? rank : rankedBidders.length + 1);
                });
             }
             
             updateSensitivityChart(analysisData, variable);
        };

        const updateSensitivityChart = (data, variable) => {
            const ctx = document.getElementById('sensitivityChart').getContext('2d');
            if (sensitivityChart) {
                sensitivityChart.destroy();
            }
            sensitivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Bidder Rank',
                        data: data.ranks,
                        borderColor: 'rgba(168, 85, 247, 1)',
                        backgroundColor: 'rgba(168, 85, 247, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: true, // Rank 1 at the top
                            beginAtZero: false,
                            min: 1,
                            title: { display: true, text: 'Auction Rank' }
                        },
                        x: {
                            title: { display: true, text: variable === 'price' ? 'Bid Price (PHP)' : 'Delivery Commencement Date' }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Rank Sensitivity to ${variable === 'price' ? 'Price' : 'DCD'}`
                        }
                    }
                }
            });
        };
        
        const runMarkovStep = () => {
            if (bidders.length === 0) {
                alert("Please load or add bidders before running the Markov simulation.");
                return;
            }

            const getNextState = (currentState) => {
                const transitions = MARKOV_TRANSITIONS[currentState];
                let rand = Math.random();
                let cumulative = 0;
                for (const state in transitions) {
                    cumulative += transitions[state];
                    if (rand < cumulative) {
                        return state;
                    }
                }
                return currentState; // Fallback
            };

            bidders.forEach(bid => {
                // Initialize state if it doesn't exist
                if (!bid.markovState) {
                    const states = ['Aggressive', 'Moderate', 'Conservative'];
                    bid.markovState = states[Math.floor(Math.random() * states.length)];
                }

                // Transition to the next state
                bid.markovState = getNextState(bid.markovState);

                // Update prices based on the new state
                const isChineseEnabled = dom.chineseTurbineToggle.checked;
                const discountFactor = isChineseEnabled ? (1 - CHINESE_TURBINE_DISCOUNT) : 1;
                const priceRange = (bid.basePriceMax || bid.basePriceMin) - bid.basePriceMin;
                let newPrice;

                switch (bid.markovState) {
                    case 'Aggressive':
                        newPrice = bid.basePriceMin + Math.random() * (priceRange * 0.33);
                        break;
                    case 'Moderate':
                        newPrice = bid.basePriceMin + (priceRange * 0.33) + Math.random() * (priceRange * 0.34);
                        break;
                    case 'Conservative':
                        newPrice = bid.basePriceMin + (priceRange * 0.67) + Math.random() * (priceRange * 0.33);
                        break;
                }
                bid.priceMin = newPrice * discountFactor;
                bid.priceMax = (newPrice + 0.2 + Math.random() * 0.1) * discountFactor;
                
            });

            calculateAndRender();
            updateSimulationExplainer(rankedBiddersCache);

        };


        // --- INIT ---
        const init = () => {
            dom.gridLegendCard.style.display = 'none'; // Hide the separate grid legend card

            PRESET_BIDDERS.forEach(bidder => {
                const option = document.createElement('option'); option.value = bidder.name; option.textContent = bidder.name; dom.bidderNameSelect.appendChild(option);
            });
            const otherOption = document.createElement('option'); otherOption.value = 'other'; otherOption.textContent = '-- Other --'; dom.bidderNameSelect.appendChild(otherOption);

            document.querySelectorAll('.input, .select').forEach(el => el.addEventListener('input', calculateAndRender));
            dom.addBidderBtn.addEventListener('click', addBidder);
            dom.simulateBidsBtn.addEventListener('click', simulateBids);
            dom.clearBidsBtn.addEventListener('click', clearBidders);
            dom.bidderNameSelect.addEventListener('change', handleBidderSelectChange);
            dom.exportCsvBtn.addEventListener('click', exportToCsv);
            dom.runMonteCarloBtn.addEventListener('click', runMonteCarloAnalysis);
            dom.runSensitivityBtn.addEventListener('click', runSensitivityAnalysis);
            dom.chineseTurbineToggle.addEventListener('change', handleTurbineToggle);
            dom.runMarkovBtn.addEventListener('click', runMarkovStep);
            
            // Turbine interaction
            document.addEventListener('click', triggerSpeedUp);
            setInterval(() => {
                if (Math.random() < 0.1) { // 10% chance every 2 seconds
                    triggerSpeedUp();
                }
            }, 2000);

            PENALTY_TABLE.slice().reverse().forEach(p => { dom.penaltyTableBody.insertRow().innerHTML = `<td>≥ ${p.days}</td><td>${(p.penalty * 100).toFixed(2)}%</td>`; });
            DCD_SCORING_TABLE.forEach(d => { dom.dcdScoringTableBody.insertRow().innerHTML = `<td>${d.score}</td><td>${new Date(d.start+'T00:00:00').toLocaleDateString()}</td><td>${new Date(d.end+'T00:00:00').toLocaleDateString()}</td>`; });

            handleBidderSelectChange();
            calculateAndRender();
            initMap();
        };

        window.addEventListener('load', init);
    </script>
</body>
</html>

