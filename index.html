<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEA-5 Bid Evaluation Simulator (Advanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .label {
            display: block;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .input, .select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        .output-value {
            font-weight: 600; color: #1f2937; background-color: #f3f4f6;
            padding: 0.5rem 1rem; border-radius: 0.5rem; text-align: center;
            min-height: 42px; display: flex; align-items: center; justify-content: center;
        }
        .disqualified { color: #dc2626; font-weight: 700; }
        .qualified { color: #16a34a; font-weight: 700; }
        .info-icon { position: relative; display: inline-block; cursor: pointer; color: #6b7280; }
        .tooltip {
            visibility: hidden; width: 320px; background-color: #1f2937; color: #fff;
            text-align: left; font-weight: normal; font-size: 0.875rem; line-height: 1.5;
            border-radius: 6px; padding: 12px 16px; position: absolute; z-index: 10;
            bottom: 125%; left: 50%; margin-left: -160px; opacity: 0; transition: opacity 0.3s;
        }
        .tooltip::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent;
        }
        .info-icon:hover .tooltip { visibility: visible; opacity: 1; }
        .legend-table th, .legend-table td { padding: 0.5rem 1rem; text-align: center; border: 1px solid #e5e7eb; }
        .legend-table th { background-color: #f3f4f6; font-weight: 600; }
        .details-section {
            display: none;
            background-color: #f8f9fa;
            border-top: 1px solid #e5e7eb;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Interactive GEA-5 Bid Evaluation Simulator</h1>
            <p class="text-lg text-gray-600 mt-2">For Offshore Wind (OSW) Technology</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Section -->
            <div class="lg:col-span-2">
                 <!-- Auction Bidders -->
                <div class="card">
                    <h3 class="text-xl font-semibold mb-2 text-blue-600">Auction Bidders</h3>
                     <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center">
                        <p class="text-sm text-gray-700">
                            <span class="font-semibold">Target Period:</span> 2028-2030 | 
                            <span class="font-semibold">Total Installation Target:</span> 3,300 MW
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                             <label for="bidderNameSelect" class="label text-sm">Bidder Name</label>
                             <select id="bidderNameSelect" class="input"></select>
                             <input type="text" id="otherBidderName" class="input mt-2" placeholder="Enter custom name" style="display: none;">
                        </div>
                        <div>
                            <label for="competitorPrice" class="label text-sm">Price (PHP)</label>
                            <input type="number" id="competitorPrice" class="input" value="11.50" step="0.01">
                        </div>
                         <div>
                            <label for="competitorCapacity" class="label text-sm">Capacity (MW)</label>
                            <input type="number" id="competitorCapacity" class="input" value="850">
                        </div>
                    </div>
                    <button id="addBidderBtn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Add Bidder</button>
                    <div id="addBidderError" class="text-red-600 text-sm mt-2"></div>
                    <div id="biddersListContainer" class="mt-4 space-y-3"></div>
                </div>

                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Bid Details per Bidder</h2>
                
                <div class="card">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="foundationType" class="label">Foundation Type</label>
                            <select id="foundationType" class="select">
                                <option value="Monopile" selected>Monopile</option>
                                <option value="Jacket">Jacket</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Benchmark GEAR Price</label>
                            <div id="gearPrice" class="output-value">â‚±12.00</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-blue-600">Delivery Commencement Date (DCD)</h3>
                    <label for="dcd" class="label">Proposed DCD</label>
                    <input type="date" id="dcd" class="input" value="2028-05-15">
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-blue-600">Grid Readiness</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="gridReadinessLevel" class="label">Level of Grid Readiness</label>
                            <select id="gridReadinessLevel" class="select">
                                <option value="3">Level 3: With SIS + FS + Connection Agreement</option>
                                <option value="2" selected>Level 2: With SIS + FS</option>
                                <option value="1">Level 1: With SIS only</option>
                                <option value="0">Level 0: No SIS or grid available post-2030</option>
                            </select>
                        </div>
                        <div>
                            <label for="gridFacilityReadinessDate" class="label">Grid Facility Readiness Date</label>
                            <input type="date" id="gridFacilityReadinessDate" class="input" value="2028-08-01">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="lg:col-span-1">
                <div class="sticky top-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Auction Results</h2>
                    <div class="card">
                         <h3 class="text-xl font-semibold mb-4 text-blue-600 text-center">Auction Awarding</h3>
                         <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="installationTarget" class="label text-sm">Target (MW)</label>
                                <input type="number" id="installationTarget" class="input" value="3300">
                            </div>
                            <div>
                                <label for="marginalCap" class="label text-sm">Marginal Cap (MW)</label>
                                <input type="number" id="marginalCap" class="input" value="100">
                            </div>
                        </div>
                        <div class="mb-4 text-center p-2 bg-gray-100 rounded-md">
                            <p class="font-semibold text-sm">GEAR Ratio Benchmark: <span id="highestGearRatioValue" class="text-blue-600">0.000</span></p>
                            <p class="text-xs text-gray-500">Max(Benchmark Price / Bidder Price)</p>
                        </div>
                        <h4 class="text-lg font-semibold text-center text-gray-700 mb-2">Auction Ranking</h4>
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="py-2">Rank</th>
                                    <th class="py-2">Bidder</th>
                                    <th class="py-2 text-center">Score</th>
                                    <th class="py-2 text-center">Awarded MW</th>
                                    <th class="py-2 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legends Section -->
        <div class="mt-12">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Scoring Legends</h2>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-center">DCD Scoring Table</h3>
                        <table class="w-full legend-table">
                            <thead>
                                <tr><th>Score</th><th>Start Date</th><th>End Date</th></tr>
                            </thead>
                            <tbody id="dcdScoringTableBody"></tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-center">Score Decrement of Advance DCD vs Grid Readiness</h3>
                        <div class="max-h-64 overflow-y-auto">
                            <table class="w-full legend-table">
                                <thead><tr><th>Days Ahead</th><th>Penalty</th></tr></thead>
                                <tbody id="penaltyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-center">Grid Score & Legend</h3>
                    <table class="w-full legend-table">
                        <thead><tr><th>Score</th><th>Level</th></tr></thead>
                        <tbody>
                            <tr><td>100</td><td>3</td></tr>
                            <tr><td>75</td><td>2</td></tr>
                            <tr><td>50</td><td>1</td></tr>
                            <tr><td>Disqualified</td><td>0</td></tr>
                        </tbody>
                    </table>
                    <div class="mt-4 text-sm text-gray-600 space-y-1 text-left p-2 bg-gray-50 rounded-md">
                        <p><strong>Level 3:</strong> With SIS + FS + Connection Agreement</p>
                        <p><strong>Level 2:</strong> With SIS + FS</p>
                        <p><strong>Level 1:</strong> With SIS only</p>
                        <p><strong>Level 0:</strong> No SIS or grid available only post-2030</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA and PARAMETERS ---
        const GEAR_PRICES = { Monopile: 12.00, Jacket: 12.10 };
        const WEIGHTS = { price: 0.70, dcd: 0.10, grid: 0.10, capacity: 0.10 };
        const DCD_SCORING_TABLE = [
            { score: 100, start: '2028-01-01', end: '2028-03-31' }, { score: 95, start: '2028-04-01', end: '2028-06-30' },
            { score: 91, start: '2028-07-01', end: '2028-09-30' }, { score: 86, start: '2028-10-01', end: '2028-12-31' },
            { score: 82, start: '2029-01-01', end: '2029-03-31' }, { score: 77, start: '2029-04-01', end: '2029-06-30' },
            { score: 73, start: '2029-07-01', end: '2029-09-30' }, { score: 68, start: '2029-10-01', end: '2029-12-31' },
            { score: 64, start: '2030-01-01', end: '2030-03-31' }, { score: 59, start: '2030-04-01', end: '2030-06-30' },
            { score: 55, start: '2030-07-01', end: '2030-09-30' }, { score: 50, start: '2030-10-01', end: '2030-12-31' }
        ];
        const GRID_SCORE_TABLE = { 3: 100, 2: 75, 1: 50, 0: 'Disqualified' };
        const PENALTY_TABLE = [
            { days: 750, penalty: 0.75 }, { days: 720, penalty: 0.72 }, { days: 690, penalty: 0.69 },
            { days: 660, penalty: 0.66 }, { days: 630, penalty: 0.63 }, { days: 600, penalty: 0.60 },
            { days: 570, penalty: 0.57 }, { days: 540, penalty: 0.54 }, { days: 510, penalty: 0.51 },
            { days: 480, penalty: 0.48 }, { days: 450, penalty: 0.45 }, { days: 420, penalty: 0.42 },
            { days: 390, penalty: 0.39 }, { days: 360, penalty: 0.36 }, { days: 330, penalty: 0.33 },
            { days: 300, penalty: 0.30 }, { days: 270, penalty: 0.27 }, { days: 240, penalty: 0.24 },
            { days: 210, penalty: 0.21 }, { days: 180, penalty: 0.18 }, { days: 150, penalty: 0.15 },
            { days: 120, penalty: 0.12 }, { days: 90, penalty: 0.09 }, { days: 60, penalty: 0.06 },
            { days: 30, penalty: 0.03 }, { days: 0, penalty: 0.00 }
        ];
        const PRESET_BIDDERS = [
            { name: 'CIP & ACEN Corporation', capacity: 1000 },
            { name: 'Triconti Windkraft Group', capacity: 450 },
            { name: 'CleanTech & The Blue Circle', capacity: 1200 },
            { name: 'Corio Generation', capacity: 3000 },
            { name: 'BlueFloat Energy', capacity: 7000 },
            { name: 'BuhaWind Consortium', capacity: 4000 },
            { name: 'San Miguel Corporation', capacity: '' },
            { name: 'Aboitiz Power Corp.', capacity: '' },
            { name: 'The Lopez Group (First Gen)', capacity: '' },
        ];

        // --- GLOBAL STATE ---
        let bidders = [];
        
        // --- DOM ELEMENTS ---
        const dom = {
            biddersListContainer: document.getElementById('biddersListContainer'),
            addBidderBtn: document.getElementById('addBidderBtn'),
            bidderNameSelect: document.getElementById('bidderNameSelect'),
            otherBidderName: document.getElementById('otherBidderName'),
            competitorPrice: document.getElementById('competitorPrice'),
            competitorCapacity: document.getElementById('competitorCapacity'),
            addBidderError: document.getElementById('addBidderError'),
            foundationType: document.getElementById('foundationType'),
            gearPrice: document.getElementById('gearPrice'),
            dcd: document.getElementById('dcd'),
            gridReadinessLevel: document.getElementById('gridReadinessLevel'),
            gridFacilityReadinessDate: document.getElementById('gridFacilityReadinessDate'),
            installationTarget: document.getElementById('installationTarget'),
            marginalCap: document.getElementById('marginalCap'),
            rankingTableBody: document.getElementById('rankingTableBody'),
            penaltyTableBody: document.getElementById('penaltyTableBody'),
            dcdScoringTableBody: document.getElementById('dcdScoringTableBody'),
            highestGearRatioValue: document.getElementById('highestGearRatioValue')
        };
        
        // --- CORE FUNCTIONS ---
        const calculateScoresForBidder = (bidder, sharedDetails, maxValues) => {
            const scores = {};
            let isDisqualified = false;

            // Price Score
            const gearPrice = GEAR_PRICES[sharedDetails.foundationType];
            if (bidder.price > gearPrice) {
                isDisqualified = true;
            }
            const gearRatio = bidder.price > 0 ? gearPrice / bidder.price : 0;
            scores.gearRatio = gearRatio;
            const normalizedRatio = maxValues.highestGearRatio > 0 ? gearRatio / maxValues.highestGearRatio : 0;
            scores.priceRaw = isDisqualified ? 0 : 50 + (normalizedRatio * 50);
            scores.priceFinal = scores.priceRaw * WEIGHTS.price;

            // DCD Score
            const dcdDate = new Date(sharedDetails.dcd);
            const dcdEntry = DCD_SCORING_TABLE.find(e => dcdDate >= new Date(e.start) && dcdDate <= new Date(e.end));
            scores.dcdRaw = dcdEntry ? dcdEntry.score : 0;
            if (!dcdEntry) isDisqualified = true;
            scores.dcdFinal = scores.dcdRaw * WEIGHTS.dcd;
            
            // Grid Score
            const gridLevel = parseInt(sharedDetails.gridReadinessLevel);
            const gridBaseScore = GRID_SCORE_TABLE[gridLevel];
            if (gridBaseScore === 'Disqualified') isDisqualified = true;
            const gridDate = new Date(sharedDetails.gridFacilityReadinessDate);
            const advanceDays = Math.max(0, (gridDate - dcdDate) / (1000 * 60 * 60 * 24) * -1);
            const penaltyEntry = PENALTY_TABLE.find(p => advanceDays >= p.days);
            const penaltyPercent = penaltyEntry ? penaltyEntry.penalty : 0;
            scores.gridRaw = isDisqualified ? 0 : gridBaseScore * (1 - (penaltyPercent * 0.75));
            scores.gridFinal = scores.gridRaw * WEIGHTS.grid;

            // Capacity Score
            scores.capacityRaw = maxValues.maxOfferedCapacity > 0 ? (bidder.capacity / maxValues.maxOfferedCapacity) * 100 : 0;
            scores.capacityFinal = scores.capacityRaw * WEIGHTS.capacity;
            
            // Final Score
            scores.total = isDisqualified ? 0 : scores.priceFinal + scores.dcdFinal + scores.gridFinal + scores.capacityFinal;
            scores.isDisqualified = isDisqualified;

            return scores;
        };
        
        const calculateAndRankBids = () => {
            if (bidders.length === 0) {
                updateUI([], 0);
                return;
            }
            
            const sharedDetails = {
                foundationType: dom.foundationType.value,
                dcd: dom.dcd.value,
                gridReadinessLevel: dom.gridReadinessLevel.value,
                gridFacilityReadinessDate: dom.gridFacilityReadinessDate.value
            };
            
            // Pre-calculation to find max values
            let highestGearRatio = 0;
            let maxOfferedCapacity = 0;
            const gearPrice = GEAR_PRICES[sharedDetails.foundationType];

            bidders.forEach(bid => {
                if (bid.price <= gearPrice && bid.price > 0) {
                    highestGearRatio = Math.max(highestGearRatio, gearPrice / bid.price);
                }
                maxOfferedCapacity = Math.max(maxOfferedCapacity, bid.capacity);
            });
            
            // Final calculation with normalization
            const scoredBidders = bidders.map(bid => {
                const scores = calculateScoresForBidder(bid, sharedDetails, { highestGearRatio, maxOfferedCapacity });
                return { ...bid, ...scores };
            });

            const rankedBidders = scoredBidders.sort((a, b) => b.total - a.total);

            // Awarding Logic
            let remainingTarget = parseFloat(dom.installationTarget.value) || 0;
            const marginalCap = parseFloat(dom.marginalCap.value) || 0;
            let marginalBidderFound = false;

            rankedBidders.forEach(bid => {
                if (bid.isDisqualified) {
                    bid.awardStatus = 'Disqualified';
                    bid.awardedMW = 0;
                    return;
                }
                
                if (remainingTarget > 0 && !marginalBidderFound) {
                    if (bid.capacity <= remainingTarget) {
                        bid.awardStatus = 'Winner';
                        bid.awardedMW = bid.capacity;
                        remainingTarget -= bid.capacity;
                    } else {
                        bid.awardStatus = 'Marginal';
                        bid.awardedMW = Math.min(bid.capacity, remainingTarget + marginalCap);
                        remainingTarget = 0;
                        marginalBidderFound = true;
                    }
                } else {
                    bid.awardStatus = 'Loser';
                    bid.awardedMW = 0;
                }
            });

            updateUI(rankedBidders, highestGearRatio);
        };
        
        const updateUI = (rankedBidders, highestGearRatio = 0) => {
            dom.gearPrice.textContent = `â‚±${GEAR_PRICES[dom.foundationType.value].toFixed(2)}`;
            dom.highestGearRatioValue.textContent = highestGearRatio.toFixed(3);
            
            // Update Bidders List
            dom.biddersListContainer.innerHTML = rankedBidders.map((bid, index) => generateBidderHTML(bid, index)).join('');
            
            // Update Ranking Table
            let rankingHTML = rankedBidders.map((bid, index) => generateRankingRowHTML(bid, index)).join('');
            const blankRowCount = Math.max(0, 5 - rankedBidders.length);
            for (let i = 0; i < blankRowCount; i++) {
                rankingHTML += `
                    <tr class="border-b h-10">
                        <td class="py-2 text-gray-400">${rankedBidders.length + i + 1}</td>
                        <td class="text-gray-400">-</td>
                        <td class="text-center text-gray-400">-</td>
                        <td class="text-center text-gray-400">-</td>
                        <td class="text-center text-gray-400">-</td>
                    </tr>`;
            }
            dom.rankingTableBody.innerHTML = rankingHTML;
        };

        // --- HTML GENERATORS ---
        const generateBidderHTML = (bidder, index) => {
            const isFirstBidder = bidders[0] && bidder.id === bidders[0].id;
            const bgColor = bidder.isDisqualified ? 'bg-red-50' : (isFirstBidder ? 'bg-blue-50' : 'bg-gray-50');
            return `
                <div class="border rounded-lg p-3 ${bgColor}">
                    <div class="grid grid-cols-6 gap-2 items-center text-sm">
                        <div class="col-span-2 font-semibold text-gray-800">
                            ${index + 1}. ${bidder.name}
                        </div>
                        <div class="text-center">
                            <span class="block text-xs text-gray-500">Price</span>
                            â‚±${bidder.price.toFixed(2)}
                        </div>
                        <div class="text-center">
                            <span class="block text-xs text-gray-500">Capacity</span>
                            ${bidder.capacity} MW
                        </div>
                         <div class="text-center font-bold text-blue-600">
                            <span class="block text-xs text-gray-500 font-medium">Score</span>
                            ${bidder.total.toFixed(2)}
                        </div>
                        <div class="text-right">
                             <button onclick="toggleDetails('${bidder.id}')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded">Details</button>
                             <button onclick="removeBidder('${bidder.id}')" class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded">&times;</button>
                        </div>
                    </div>
                    <div id="details-${bidder.id}" class="details-section">
                        ${generateScoreBreakdownHTML(bidder)}
                    </div>
                </div>`;
        };
        
        const generateScoreBreakdownHTML = (bidder) => {
             if (!bidder) return '';
             const gearPrice = GEAR_PRICES[dom.foundationType.value];
             return `
                <div class="text-center mb-2 p-2 bg-white rounded-md border">
                    <p class="font-semibold text-sm">GEAR Ratio: <span class="text-blue-600">${bidder.gearRatio.toFixed(3)}</span></p>
                    <p class="text-xs text-gray-500">Benchmark (â‚±${gearPrice.toFixed(2)}) / Offered Price (â‚±${bidder.price.toFixed(2)})</p>
                </div>
                <table class="w-full text-left text-xs">
                    <thead><tr class="border-b"><th class="py-1">Criterion</th><th class="text-center">Raw</th><th class="text-center">Final</th></tr></thead>
                    <tbody>
                        <tr><td>Price</td><td class="text-center">${bidder.priceRaw.toFixed(2)}</td><td class="text-center">${bidder.priceFinal.toFixed(2)}</td></tr>
                        <tr class="bg-white"><td>DCD</td><td class="text-center">${bidder.dcdRaw.toFixed(2)}</td><td class="text-center">${bidder.dcdFinal.toFixed(2)}</td></tr>
                        <tr><td>Grid</td><td class="text-center">${bidder.gridRaw.toFixed(2)}</td><td class="text-center">${bidder.gridFinal.toFixed(2)}</td></tr>
                        <tr class="bg-white"><td>Capacity</td><td class="text-center">${bidder.capacityRaw.toFixed(2)}</td><td class="text-center">${bidder.capacityFinal.toFixed(2)}</td></tr>
                    </tbody>
                </table>`;
        };

        const generateRankingRowHTML = (bid, index) => {
            let statusClass = '';
            if (bid.awardStatus === 'Winner' || bid.awardStatus === 'Marginal') statusClass = 'text-green-600';
            else if (bid.awardStatus === 'Loser') statusClass = 'text-red-600';
            return `
                <tr class="border-b">
                    <td class="py-2">${index + 1}</td>
                    <td class="py-2 font-medium">${bid.name}</td>
                    <td class="py-2 text-center">${bid.total.toFixed(2)}</td>
                    <td class="py-2 text-center">${bid.awardedMW}</td>
                    <td class="py-2 text-center font-semibold ${statusClass}">${bid.awardStatus}</td>
                </tr>`;
        };
        
        // --- EVENT HANDLERS & INITIALIZATION ---
        const addBidder = () => {
            // Clear previous errors
            dom.bidderNameSelect.classList.remove('border-red-500');
            dom.otherBidderName.classList.remove('border-red-500');
            dom.competitorPrice.classList.remove('border-red-500');
            dom.competitorCapacity.classList.remove('border-red-500');
            dom.addBidderError.textContent = '';

            const selectedName = dom.bidderNameSelect.value;
            const name = selectedName === 'other' ? dom.otherBidderName.value.trim() : selectedName;
            const price = parseFloat(dom.competitorPrice.value);
            const capacity = parseInt(dom.competitorCapacity.value);
            
            let errors = [];
            if (!name) {
                errors.push('name');
                if (selectedName === 'other') {
                    dom.otherBidderName.classList.add('border-red-500');
                } else {
                    dom.bidderNameSelect.classList.add('border-red-500');
                }
            }
            if (isNaN(price) || dom.competitorPrice.value.trim() === '') {
                errors.push('price');
                dom.competitorPrice.classList.add('border-red-500');
            }
            if (isNaN(capacity) || dom.competitorCapacity.value.trim() === '') {
                errors.push('capacity');
                dom.competitorCapacity.classList.add('border-red-500');
            }

            if (errors.length > 0) {
                dom.addBidderError.textContent = `Please provide a valid ${errors.join(', ')}.`;
            } else {
                bidders.push({ id: `bid_${Date.now()}`, name, price, capacity });
                dom.otherBidderName.value = '';
                dom.bidderNameSelect.selectedIndex = 0;
                handleBidderSelectChange(); // Reset to first bidder's capacity
                calculateAndRankBids();
            }
        };
        
        const handleBidderSelectChange = () => {
            const selectedValue = dom.bidderNameSelect.value;
            if (selectedValue === 'other') {
                dom.otherBidderName.style.display = 'block';
                dom.competitorCapacity.value = ''; // Clear capacity for custom entry
            } else {
                dom.otherBidderName.style.display = 'none';
                const selectedBidder = PRESET_BIDDERS.find(b => b.name === selectedValue);
                if (selectedBidder) {
                    dom.competitorCapacity.value = selectedBidder.capacity;
                }
            }
        };

        window.removeBidder = (id) => {
            bidders = bidders.filter(b => b.id !== id);
            calculateAndRankBids();
        };

        window.toggleDetails = (id) => {
            const detailsEl = document.getElementById(`details-${id}`);
            if (detailsEl) {
                detailsEl.style.display = detailsEl.style.display === 'block' ? 'none' : 'block';
            }
        };

        const init = () => {
            // Populate Bidder Dropdown
            PRESET_BIDDERS.forEach(bidder => {
                const option = document.createElement('option');
                option.value = bidder.name;
                option.textContent = bidder.name;
                dom.bidderNameSelect.appendChild(option);
            });
            const otherOption = document.createElement('option');
            otherOption.value = 'other';
            otherOption.textContent = '-- Other --';
            dom.bidderNameSelect.appendChild(otherOption);

            dom.addBidderBtn.addEventListener('click', addBidder);
            dom.bidderNameSelect.addEventListener('change', handleBidderSelectChange);

            document.querySelectorAll('.input, .select').forEach(el => {
                el.addEventListener('input', calculateAndRankBids);
            });

            // Populate Legend Tables
            PENALTY_TABLE.slice().reverse().forEach(p => {
                const row = dom.penaltyTableBody.insertRow();
                row.innerHTML = `<td>â‰¥ ${p.days}</td><td>${(p.penalty * 100).toFixed(2)}%</td>`;
            });
            DCD_SCORING_TABLE.forEach(d => {
                 const row = dom.dcdScoringTableBody.insertRow();
                 row.innerHTML = `<td>${d.score}</td><td>${new Date(d.start+'T00:00:00').toLocaleDateString()}</td><td>${new Date(d.end+'T00:00:00').toLocaleDateString()}</td>`;
            });
            
            handleBidderSelectChange(); // Set initial capacity
            calculateAndRankBids();
        };

        window.addEventListener('load', init);
    </script>
</body>
</html>


